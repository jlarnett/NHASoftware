@using NHA.Website.Software.Views.Anime.Vms
@model RollViewModel
@{
    ViewData["Title"] = "Anime";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<head>
    <link rel="stylesheet" href="~/css/AnimePages.css">
    <link rel="stylesheet" href="~/css/AnimeRoll.css"/>
</head>

<div id="AnimeRollFeed" class="feed" tabindex="0">
    @foreach (var anime in Model.RollAnime)
    {
        <div class="row vh-100 d-flex justify-content-center align-items-center" >
            <!-- Side spacing columns only on md and up -->
            <div class="d-none d-md-block col-md-1"></div>

            <div class="col vh-100 align-content-center">
                <!-- Trailer -->
                <div class="video-container ratio ratio-16x9 rounded-2 overflow-hidden">
                    <iframe src="@anime.TrailerUrl?enablejsapi=1&mute=1"
                            id="anime-@anime.Id"
                            class="anime-video"
                            title="@anime.AnimeName Trailer"
                            loading="lazy"
                            allow="accelerometer; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                            allowfullscreen
                            referrerpolicy="strict-origin-when-cross-origin">
                    </iframe>
                </div>

                <!-- Anime name below -->
                <div class="mt-2">
                    <a class="text-primary interactable" asp-controller="Anime" asp-action="AnimePageDetails" asp-route-id="@anime.Id">@anime.AnimeName</a>
                </div>
                <div class="mt-1 multiline-ellipsis">
                    <h5 class="text-body">@anime.AnimeSummary</h5>
                </div>
                
                @{
                    if (!Model.RollAnime.Last().Equals(anime))
                    {
                        <div class="text-center">
                            <a class="scroll-down link-primary">
                                <i class="bi bi-arrow-down interactable" style="font-size: 2rem;"></i>
                            </a>
                        </div>
                    }
                }
            </div>

            <!-- Side spacing columns only on md and up -->
            <div class="d-none d-md-block col-md-1"></div>
        </div>

        <hr>
    }

</div>

@{
    var newPageNumber = Model.Page + 1;
}
<div class="row">
    <!-- Side spacing columns only on md and up -->
    <div class="d-none d-md-block col-md-1"></div>
    <a class="btn btn-outline-primary" style="display: none;" class="btn btn-primary col" asp-controller="Anime" asp-action="Roll" asp-route-pageNumber="@newPageNumber">Load more</a>
    <!-- Side spacing columns only on md and up -->
    <div class="d-none d-md-block col-md-1"></div>
</div>
<script src="https://www.youtube.com/iframe_api"></script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        let players = [];

        window.onYouTubeIframeAPIReady = function() {
            const iframes = document.querySelectorAll('.anime-video');

            // Create YT.Player instances
            iframes.forEach(iframe => {
                const player = new YT.Player(iframe.id, {
                    events: {
                        'onReady': event => {
                            event.target.mute(); // initially muted
                        }
                    }
                });
                players.push(player);
            });

            // Scroll observer
            const observer = new IntersectionObserver(entries => {
                entries.forEach(entry => {
                    const idx = Array.from(iframes).indexOf(entry.target);
                    const player = players[idx];
                    if (!player || !player.playVideo) return;

                    if (entry.isIntersecting) {
                        // Unmute the new video
                        player.setVolume(50);
                        player.unMute();
                        player.playVideo();

                        // Mute all other videos
                        players.forEach((p, i) => {
                            if (i !== idx && p.pauseVideo) {
                                p.mute();
                                p.pauseVideo(); // optional, pause others
                            }
                        });
                    } else {
                        // Mute videos when scrolled out
                        player.mute();
                        player.pauseVideo(); // optional
                    }
                });
            }, { threshold: 0.5 });

            iframes.forEach(iframe => observer.observe(iframe));
        };
    });
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const feed = document.querySelector('.feed');
    const nextPageUrl = "@Url.Action("Roll", "Anime", new { pageNumber = newPageNumber })";

    feed.addEventListener('scroll', () => {
        // how close to the bottom we trigger (px)
        const threshold = 5;

        if (feed.scrollTop + feed.clientHeight >= feed.scrollHeight - threshold) {
            window.location.href = nextPageUrl;
        }
    });

    // Arrow down key event
    document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowDown') {

            // Check if we reached the bottom
            if (feed.scrollTop + feed.clientHeight >= feed.scrollHeight - threshold) {
                window.location.href = nextPageUrl;
            }

            // Prevent the default arrow behavior if needed
            e.preventDefault();
        }
    });
    const scrollStep = 100; // pixels to scroll per click
    const links = document.querySelectorAll('.scroll-down');
    links.forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            // Scroll the feed down
            feed.scrollTop += scrollStep;
        });
    });
});
</script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const element = document.getElementById('AnimeRollFeed');
        if (element) {
            element.focus();
        }
    });



</script>

