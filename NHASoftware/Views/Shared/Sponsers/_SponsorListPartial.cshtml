@using NHA.Website.Software.Entities.Anime
@using NHA.Website.Software.FeatureManagement
@using NHA.Website.Software.Services.RepositoryPatternFoundationals
@using NHA.Website.Software.Services.Sponsors
@using NHA.Website.Software.Views.Shared.Sponsers.ViewModel
@inject IAdMaximizerService AdMaximizerService
@inject IUnitOfWork UnitOfWork

@{
    var featuredAnime = (await UnitOfWork.AnimePageRepository.FindAsync(a => a.Featured)).FirstOrDefault();
}

@{
    <div id="SponsorListUI" class="col position-fixed pb-5 mx-auto overflow-scroll w-inherit" style="height: 100%;">
    
        @if (featuredAnime is not null)
        {
            <div class="row">
                <div class="featured-header">
                    <span>Featured</span>
                </div>
            </div>
        
            <div class="row m-auto pt-1 pb-1 text-center">
                <a asp-action="AnimePageDetails" class="h5 text-body text-decoration-none interactable fw-semibold" asp-controller="Anime" asp-route-id="@featuredAnime.Id">@featuredAnime.AnimeName</a>
                <div class="">
                    <a class="row text-center m-auto rounded-2 interactable" asp-controller="Anime" asp-action="AnimePageDetails" asp-route-id="@featuredAnime.Id">
                        <img src="@featuredAnime.AnimeImageUrl" class="rounded-3 p-0" alt="@featuredAnime.AnimeName's cover photo" />
                    </a>
                </div>
                <div class="multiline-ellipsis" style="max-width: 350px;">
                    @Html.Raw(@featuredAnime.AnimeSummary)
                    @Html.Raw(@featuredAnime.AnimeBackground)
                </div>
                
                @{ await Html.RenderPartialAsync("Sponsers/_GenreListPartial", new GenreListVm(@featuredAnime.AnimeGenres ?? string.Empty, GenreListType.Anime)); }
                <div class="row mt-2 me-2"></div>
                @{ await Html.RenderPartialAsync("Sponsers/_GenreListPartial", new GenreListVm(@featuredAnime.Platforms ?? string.Empty, GenreListType.StreamingPlatform)); }

            </div>
        }

        <div class="row">
            <div class="featured-header">
                <span>Sponsors</span>
            </div>
        </div>

        @{
            var ads = await AdMaximizerService.GetBestAdsForUserAsync();

            foreach (var ad in ads)
            {

                if (ad.VideoUrl != null)
                {
                    <feature name="@FeatureFlags.SponsorAdsEnabled">
                        <div class="row m-auto pt-1 pb-1 text-center">
                            <div class="col">
                                <div class="ratio ratio-16x9 rounded-2 overflow-hidden">
                                    <iframe src="@ad.VideoUrl"
                                            title="YouTube video"
                                            allowfullscreen
                                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture">
                                    </iframe>
                                </div>
                            </div>
                        </div>
                    </feature>
                }

                if (ad.ImageUrl != null)
                {
                    <div class="row m-auto pt-1 pb-1 text-center">
                        <iframe src=@ad.ImageUrl
                                title="Sponsor Video"
                                height="350px"
                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                                allowfullscreen>
                        </iframe>
                    </div>
                }
            }
        }
        <div class="row m-auto pt-1 pb-1">
            <p>Huge shoutout to all of our sponsors for supporting the site, it wouldn't be possible without you.</p>
            <p>if you would like your channel, product, or video promoted or featured click <a asp-controller="Home" asp-action="Index" class="link-primary">here</a>.</p>
        </div>
    </div>
}